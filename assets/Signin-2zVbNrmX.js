import{j as e,E as j,D as E,a as U,k as $,i as G,G as F,H as S,I as A,m as w,L as Y}from"./index-D9oEtHeb.js";import{u as N,F as P}from"./FormField-pkCODe5l.js";import{o as v}from"./index.esm-DgqbvREp.js";import{a as b}from"./useApi-HEZO75xY.js";import{s as T,C as W}from"./index-Cb_V-kUK.js";import{O as V,S as _,l as q,P as J}from"./validationSchema-Dhfv0G6R.js";import{M as K}from"./Modal-BJGjPyn5.js";import{P as I}from"./Paper-B5GudHh1.js";import{T as H}from"./Title-BU25imyy.js";import{S as k}from"./Stack-CmwLihlq.js";import{T as M}from"./TextInput-CYS3MMnp.js";import{B as z}from"./Button-DE9b1J-V.js";import{T as B}from"./Text-8hgcObZb.js";import{G as D}from"./Group-B6akqJOh.js";import"./create-optional-context-nOeOZdkc.js";import"./DirectionProvider-D6EKyNqO.js";import"./Popover-CTkB1yWX.js";import"./get-floating-position-B7o6aoca.js";import"./FocusTrap-CENGLIKd.js";import"./create-safe-context-BzETH9ei.js";import"./use-uncontrolled-NxHOPr4h.js";import"./ComboboxChevron-CZUbivVw.js";import"./ActionIcon-CBmGwXDV.js";import"./get-parsed-combobox-data-BSKT1ADk.js";const Q={userType:"",password:""};function X({opened:h,onComplete:a,accessToken:m}){const{control:f,handleSubmit:l}=N({defaultValues:Q,resolver:v(V),mode:"onSubmit"}),{patch:g}=b(),x=async u=>{const y={"Content-Type":"application/json",Authorization:`Bearer ${m}`};try{const{data:t}=await g(E.AUTH.SELECT_ROLE,u,y);a({user:t})}catch(t){return Promise.reject("Complete profile error:",t)}};return e.jsx(K,{opened:h,onClose:()=>{},withCloseButton:!1,title:"Please Update Your Credentials",centered:!0,children:e.jsx(I,{shadow:"md",radius:"md",p:"xl",withBorder:!0,w:"400px",mx:"auto",children:e.jsxs("form",{onSubmit:l(x),children:[e.jsx(H,{order:3,mb:"md",children:"Complete Your Profile"}),e.jsxs(k,{children:[e.jsx(P,{name:"userType",control:f,Component:_,componentProps:{label:"User Type",placeholder:"Select a user type",data:[{value:j.CREATOR,label:"Creator"},{value:j.BRAND,label:"Brand"},{value:j.COMMUNITY,label:"Community"}],withAsterisk:!0,searchable:!0,nothingFoundMessage:"No match"}}),e.jsx(P,{name:"password",control:f,Component:M,componentProps:{label:"Set a Password",type:"password",placeholder:"Enter your password",withAsterisk:!0}}),e.jsx(z,{fullWidth:!0,mt:"md",type:"submit",children:"Complete & Login"})]})]})})})}const Z=()=>{const[h,a]=U.useState(!1),[m,f]=U.useState(null),l=$(),g=G(),{post:x,get:u}=b(),y=async s=>{var i,n,r,d,c;try{const{data:o}=await x(E.AUTH.GOOGLE_OAUTH,{token:s==null?void 0:s.credential}),p=!((i=o.user)!=null&&i.userType);if(console.log((n=o.user)==null?void 0:n.userType),p)a(!0),f({accessToken:o.accessToken,refreshToken:o.refreshToken,user:o.user});else{l(S({accessToken:o.accessToken,refreshToken:o.refreshToken,user:o.user}));const C=(r=o==null?void 0:o.user)==null?void 0:r.id,O=(c=(d=o==null?void 0:o.user)==null?void 0:d.userType)==null?void 0:c.toUpperCase(),L=O==="BRAND"?"brandProfile":O==="CREATOR"?"creatorProfile":"",{data:R}=await u(`/users/${C}${L?`?populate=${L}`:""}`);console.log(R),l(A({user:R}))}}catch(o){T("Login Error",`{${(o==null?void 0:o.message)||"Something went wrong with Google login"} }`,"red")}},t=async({user:s})=>{var o,p,C;l(S({accessToken:s.accessToken,refreshToken:s.refreshToken,user:s.user}));const i=(o=s==null?void 0:s.user)==null?void 0:o.id,n=(C=(p=s==null?void 0:s.user)==null?void 0:p.userType)==null?void 0:C.toUpperCase();console.log(s);const r=n==="BRAND"?"brandProfile":n==="CREATOR"?"creatorProfile":"",d={"Content-Type":"application/json",Authorization:`Bearer ${s.accessToken}`},{data:c}=await u(`/users/${i}${r?`?populate=${r}`:""}`,d);l(A({user:c})),a(!1),T("Login Successful",`Welcome back, ${s.username}`),g(w.ACCOUNTS.DASHBOARD.ROOT)};return e.jsxs(e.Fragment,{children:[e.jsx(F,{onSuccess:y,onError:()=>T("Login Error","Google sign-in failed","red")}),e.jsx(X,{opened:h,onClose:()=>a(!1),onComplete:t,accessToken:m==null?void 0:m.accessToken})]})},ee={identifier:"",password:""},oe=[{name:"identifier",label:"Username or email address",placeholder:"Your username or email address",type:M},{name:"password",label:"Password",placeholder:"Your password",type:J}];function ke(){const h=$(),a=G(),{control:m,handleSubmit:f}=N({defaultValues:ee,resolver:v(q),mode:"onSubmit"}),{post:l,get:g,loading:x,error:u}=b(),y=async t=>{var s,i,n;try{const{data:r}=await l(E.AUTH.LOGIN,t);console.log(r),h(S({accessToken:r.accessToken,refreshToken:r.refreshToken,user:r.user}));const d=(s=r==null?void 0:r.user)==null?void 0:s.id,c=(n=(i=r==null?void 0:r.user)==null?void 0:i.userType)==null?void 0:n.toUpperCase();if(!d||!c){T("Login Error","User information incomplete","red"),a(w.WELCOMEPAGE);return}const o=c==="BRAND"?"brandProfile":c==="CREATOR"?"creatorProfile":"",{data:p}=await g(`/users/${d}${o?`?populate=${o}`:""}`);console.log(p),h(A({user:p})),T("Login Successful",`Welcome back, ${p.username||"user"}!`),a(w.ACCOUNTS.DASHBOARD.ROOT)}catch(r){T("Login Error",(r==null?void 0:r.message)||"Something went wrong","red"),a(w.WELCOMEPAGE)}};return e.jsx(W,{size:"md",children:e.jsx(I,{radius:"sm",p:"xl",withBorder:!0,bg:"#363a3e",my:"5em",mx:"xl",children:e.jsx("form",{onSubmit:f(y),children:e.jsxs(k,{spacing:"xl",children:[e.jsx(H,{order:2,children:"Login"}),u&&e.jsx(B,{c:"red",size:"sm",children:u}),e.jsxs(k,{w:"50%",mx:"auto",children:[oe.map(({name:t,label:s,placeholder:i,type:n})=>e.jsx(P,{name:t,control:m,Component:n,componentProps:{label:s,placeholder:i,withAsterisk:!0}},t)),e.jsx(D,{position:"center",mt:"md",style:{justifyContent:"center"},children:e.jsx(z,{variant:"primary",size:"sm",type:"submit",loading:x,children:"Login"})}),e.jsxs(B,{size:"xs",mt:"sm",align:"center",children:["Don't have an account?"," ",e.jsx(Y,{to:"/register",style:{textDecoration:"none"},children:"Register"})]})]}),e.jsx(D,{position:"center",style:{justifyContent:"center"},children:e.jsx(Z,{})})]})})})})}export{ke as default};
